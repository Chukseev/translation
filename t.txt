Настройка WebRTC трансляции с использованием Janus и OBS

1. Установка и настройка Janus

   1.1 Установка зависимостей

   Перед установкой Janus, необходимо установить зависимости:

   sudo apt-get update
   sudo apt-get install libmicrohttpd-dev libjansson-dev \
       libssl-dev libsrtp2-dev libsofia-sip-ua-dev libglib2.0-dev \
       libopus-dev libogg-dev libini-config-dev libcollection-dev \
       libconfig-dev pkg-config gengetopt libtool autoconf automake

   1.2 Установка Janus

   Скачайте и установите Janus:

   git clone https://github.com/meetecho/janus-gateway.git
   cd janus-gateway
   sh autogen.sh
   ./configure --disable-websockets --disable-data-channels --disable-rabbitmq --disable-mqtt --disable-docs
   make
   sudo make install
   sudo make configs

   1.3 Настройка Janus для работы с WebRTC и RTMP

   Откройте конфигурационный файл janus.jcfg (обычно находится в /usr/local/etc/janus/janus.jcfg) и внесите изменения для активации RTMP-плагина:

   rtmp = yes

   Настройте RTMP-плагин, отредактировав файл rtp.jcfg:

   rtmp {
       # Порт для RTMP входящих потоков
       port = 1935

       # Каталог для временных HLS файлов
       hls_output_path = "/tmp/janus/hls"
   }

   Перезапустите Janus после внесения изменений:

   sudo systemctl restart janus


2. Настройка OBS для передачи на Janus

   2.1 Откройте OBS и перейдите в настройки.

   2.2 В разделе Stream выберите Custom....

   2.3 Введите URL вашего Janus сервера: rtmp://<ваш_сервер_IP>/live.

   2.4 Введите Stream Key, например stream.

   2.5 Начните трансляцию, нажав "Start Streaming".


3. Создание HTML-страницы для воспроизведения WebRTC

   Создайте HTML-файл index.html:

   <!DOCTYPE html>
   <html lang="en">
   <head>
       <meta charset="UTF-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <title>WebRTC Stream</title>
       <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
       <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
       <script src="https://janus.conf.meetecho.com/janus.js"></script>
   </head>
   <body>
       <h1>Live Stream via WebRTC</h1>
       <video id="remotevideo" width="640" height="360" autoplay playsinline></video>

       <script>
           const server = "ws://<ваш_сервер_IP>:8188/janus";
           const janus = new Janus({
               server: server,
               success: function() {
                   janus.attach({
                       plugin: "janus.plugin.streaming",
                       success: function(pluginHandle) {
                           const streaming = pluginHandle;
                           streaming.send({message: {request: "watch", id: 1}});
                       },
                       onmessage: function(msg, jsep) {
                           if(jsep !== undefined && jsep !== null) {
                               streaming.createAnswer({
                                   jsep: jsep,
                                   media: {audioSend: false, videoSend: false},
                                   success: function(jsep) {
                                       const body = {request: "start"};
                                       streaming.send({message: body, jsep: jsep});
                                   },
                               });
                           }
                       },
                       onremotestream: function(stream) {
                           const videoElement = document.getElementById('remotevideo');
                           Janus.attachMediaStream(videoElement, stream);
                       },
                   });
               }
           });
       </script>
   </body>
   </html>

   Замените <ваш_сервер_IP> на IP-адрес вашего сервера Janus.


4. Проверка URL Janus сервера

   URL вашего Janus сервера должен выглядеть следующим образом:

   - Если Janus запущен локально и используется незащищенное соединение:
     ws://localhost:8188/janus

   - Если Janus запущен на удаленном сервере с IP-адресом 123.45.67.89 и используется незащищенное соединение:
     ws://123.45.67.89:8188/janus

   - Если Janus настроен на использование HTTPS:
     wss://123.45.67.89:8989/janus

   Проверьте конфигурацию Janus и используйте правильный URL в вашем HTML-файле.


5. Заключение

   Теперь, когда вы настроили Janus и OBS, запустите трансляцию из OBS и откройте вашу HTML-страницу в браузере. Вы должны увидеть живую трансляцию через WebRTC.
